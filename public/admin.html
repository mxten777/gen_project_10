<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†¡ë…„íšŒ ê´€ë¦¬ì - ê°„ë‹¨ ë²„ì „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/firebase-config.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">
                ğŸ‰ ì˜¤ì‚°ê³  71íšŒ ì†¡ë…„íšŒ
            </h1>
            <p class="text-blue-200 text-lg">ê´€ë¦¬ì í˜ì´ì§€ (ê°„ë‹¨ ë²„ì „)</p>
            <div class="mt-2">
                <a href="debug.html" class="text-blue-300 hover:text-white text-sm underline">
                    ğŸ”§ ì‹œìŠ¤í…œ ë””ë²„ê·¸
                </a>
            </div>
            
            <div class="mt-4 bg-blue-800 bg-opacity-50 rounded-lg p-4">
                <p class="text-white text-lg">
                    ì´ <span id="totalCount" class="font-bold text-yellow-300">0ëª…</span> ì¤‘ 
                    <span id="checkedInCount" class="font-bold text-green-300">0ëª…</span> ì²´í¬ì¸ ì™„ë£Œ
                </p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ì°¸ì„ì ì¶”ê°€ -->
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-blue-500">
                <h3 class="text-xl font-semibold text-white mb-4">ì°¸ì„ì ì¶”ê°€</h3>
                <div class="space-y-4">
                    <input
                        type="text"
                        id="newName"
                        placeholder="ì´ë¦„"
                        class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-blue-400 focus:outline-none"
                    />
                    <input
                        type="text"
                        id="newPhone"
                        placeholder="ì „í™”ë²ˆí˜¸ (ì„ íƒì‚¬í•­)"
                        class="w-full p-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-blue-400 focus:outline-none"
                    />
                    <button
                        onclick="addAttendee()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ì¶”ê°€
                    </button>
                </div>
            </div>

            <!-- ê°„ë‹¨í•œ ê´€ë¦¬ ë©”ë‰´ -->
            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-green-500">
                <h3 class="text-xl font-semibold text-white mb-4">ê´€ë¦¬</h3>
                <div class="space-y-3">
                    <button
                        onclick="copyToClipboard()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬
                    </button>
                    <button
                        onclick="exportToCSV()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ“ CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button
                        onclick="exportForSharing()"
                        class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ“¤ ê³µìœ ìš© ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button
                        onclick="refreshAllData()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button
                        onclick="showQuickStats()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ“Š ë¹ ë¥¸ í†µê³„
                    </button>
                    <button
                        onclick="generateSampleData()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ­ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
                    </button>
                    <button
                        onclick="confirmCompleteReset()"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                    >
                        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì°¸ì„ì ëª©ë¡ -->
        <div class="mt-6 bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-purple-500">
            <h3 class="text-xl font-semibold text-white mb-4">ì°¸ì„ì ëª©ë¡</h3>
            <div id="attendeeList" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-gray-400 text-center py-8">ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <script>
        let attendees = [];
        let firebaseUnsubscribe = null;

        // Firebase ìƒíƒœ í‘œì‹œ
        function updateFirebaseStatus(status, message) {
            // ê°„ë‹¨í•œ ìƒíƒœ í‘œì‹œë§Œ
            console.log(`Firebase ${status}: ${message}`);
        }

        // ì°¸ì„ì ì¶”ê°€
        async function addAttendee() {
            const nameInput = document.getElementById('newName');
            const phoneInput = document.getElementById('newPhone');
            
            const name = nameInput.value.trim();
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                nameInput.focus();
                return;
            }

            const phone = phoneInput.value.trim();
            const attendee = {
                id: Date.now().toString(),
                name,
                phone,
                checkedIn: false,
                timestamp: new Date().toISOString()
            };

            try {
                // Firebaseì— ì¶”ê°€
                if (window.firebaseManager) {
                    await window.firebaseManager.addAttendee(attendee);
                    console.log('Firebaseì— ì¶”ê°€ë¨');
                }

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                nameInput.value = '';
                phoneInput.value = '';
                nameInput.focus();
            } catch (error) {
                console.error('ì¶”ê°€ ì‹¤íŒ¨:', error);
                alert('ì°¸ì„ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì°¸ì„ì ì‚­ì œ
        async function deleteAttendee(id) {
            if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                if (window.firebaseManager) {
                    await window.firebaseManager.deleteAttendee(id);
                    console.log('ì‚­ì œë¨');
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì²´í¬ì¸ í† ê¸€
        async function toggleCheckin(id) {
            try {
                const attendee = attendees.find(a => a.id === id);
                if (!attendee) return;

                const newStatus = !attendee.checkedIn;
                const updateData = {
                    checkedIn: newStatus,
                    checkedInAt: newStatus ? new Date().toISOString() : ''
                };

                if (window.firebaseManager) {
                    await window.firebaseManager.updateAttendee(id, updateData);
                    console.log('ì²´í¬ì¸ ìƒíƒœ ë³€ê²½ë¨');
                }
            } catch (error) {
                console.error('ì²´í¬ì¸ ì‹¤íŒ¨:', error);
                alert('ì²´í¬ì¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            document.getElementById('totalCount').textContent = attendees.length;
            document.getElementById('checkedInCount').textContent = 
                attendees.filter(a => a.checkedIn).length;

            const listElement = document.getElementById('attendeeList');
            if (attendees.length === 0) {
                listElement.innerHTML = '<div class="text-gray-400 text-center py-8">ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ì´ë¦„ìˆœ ì •ë ¬
            const sortedAttendees = [...attendees].sort((a, b) => a.name.localeCompare(b.name));

            listElement.innerHTML = sortedAttendees.map(attendee => `
                <div class="bg-white bg-opacity-5 rounded-lg p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <div class="flex-grow">
                        <div class="flex items-center gap-3">
                            <span class="text-white font-semibold">${attendee.name}</span>
                            ${attendee.checkedIn ? 
                                '<span class="bg-green-600 text-white px-2 py-1 rounded-full text-xs">âœ“ ì²´í¬ì¸</span>' :
                                '<span class="bg-gray-600 text-white px-2 py-1 rounded-full text-xs">ëŒ€ê¸°</span>'
                            }
                        </div>
                        ${attendee.phone ? `<div class="text-gray-300 text-sm mt-1">${attendee.phone}</div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="toggleCheckin('${attendee.id}')" 
                            class="px-3 py-1 rounded text-sm font-medium transition-colors ${
                                attendee.checkedIn 
                                    ? 'bg-green-600 hover:bg-green-700 text-white' 
                                    : 'bg-blue-600 hover:bg-blue-700 text-white'
                            }">
                            ${attendee.checkedIn ? 'ì²´í¬ì•„ì›ƒ' : 'ì²´í¬ì¸'}
                        </button>
                        <button 
                            onclick="deleteAttendee('${attendee.id}')" 
                            class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium transition-colors">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        function copyToClipboard() {
            if (attendees.length === 0) {
                alert('ë³µì‚¬í•  ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const text = attendees
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(a => `${a.name}${a.phone ? ` (${a.phone})` : ''} ${a.checkedIn ? 'âœ“' : 'â—‹'}`)
                .join('\n');

            navigator.clipboard.writeText(text).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            if (attendees.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const header = 'ì´ë¦„,ì „í™”ë²ˆí˜¸,ì²´í¬ì¸ìƒíƒœ,ì²´í¬ì¸ì‹œê°„\n';
            const rows = attendees
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(a => `"${a.name}","${a.phone || ''}","${a.checkedIn ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}","${a.checkedInAt || ''}"`)
                .join('\n');

            const csv = header + rows;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì†¡ë…„íšŒ_ì°¸ì„ìëª…ë‹¨_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        async function generateSampleData() {
            const count = parseInt(prompt('ìƒì„±í•  ìƒ˜í”Œ ë°ì´í„° ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '5'));
            if (isNaN(count) || count <= 0) return;

            const sampleNames = ['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ë¯¼ìˆ˜', 'ì •ìˆ˜ì—°', 'ìµœë™ìš°', 'í•œë¯¸ë˜', 'ì†¡ì§€ì›', 'ê°•íƒœí˜„', 'ì˜¤í•˜ëŠ˜', 'ì„ë°”ë‹¤'];
            
            try {
                for (let i = 0; i < count; i++) {
                    const name = sampleNames[i % sampleNames.length] + (i >= sampleNames.length ? ` ${Math.floor(i / sampleNames.length) + 1}` : '');
                    const phone = `010-${String(Math.floor(Math.random() * 9000) + 1000)}-${String(Math.floor(Math.random() * 9000) + 1000)}`;
                    
                    const attendee = {
                        id: Date.now().toString() + i,
                        name,
                        phone,
                        checkedIn: Math.random() > 0.7, // 30% ì²´í¬ì¸
                        timestamp: new Date().toISOString()
                    };

                    if (attendee.checkedIn) {
                        attendee.checkedInAt = new Date().toISOString();
                    }

                    if (window.firebaseManager) {
                        await window.firebaseManager.addAttendee(attendee);
                    }
                }
                alert(`${count}ê°œì˜ ìƒ˜í”Œ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ìƒ˜í”Œ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ìƒ˜í”Œ ë°ì´í„° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì²´ ì‚­ì œ
        async function confirmCompleteReset() {
            if (attendees.length === 0) {
                alert('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // 1ë‹¨ê³„: ê¸°ë³¸ í™•ì¸
            if (!confirm(`âš ï¸ ì „ì²´ ì‚­ì œ

í˜„ì¬ ${attendees.length}ëª…ì˜ ì°¸ì„ì ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.

ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // 2ë‹¨ê³„: ìµœì¢… í™•ì¸ (ì•ˆì „ ì½”ë“œ)
            const safetyCode = Math.floor(1000 + Math.random() * 9000);
            const userInput = prompt(`ğŸ” ìµœì¢… í™•ì¸

ì•ˆì „ì„ ìœ„í•´ ë‹¤ìŒ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”:
${safetyCode}`);
            
            if (userInput !== String(safetyCode)) {
                alert('âŒ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            // 3ë‹¨ê³„: ì™„ì „ ì‚­ì œ ì‹¤í–‰
            try {
                // Firebase ë°ì´í„° ì‚­ì œ
                if (window.firebaseManager) {
                    await window.firebaseManager.clearAllAttendees();
                }
                
                // ë¡œì»¬ ë°ì´í„° ì‚­ì œ
                attendees = [];
                localStorage.removeItem('attendees');
                
                // UI ì—…ë°ì´íŠ¸
                updateUI();
                
                alert('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Firebase ë°ì´í„° ë¡œë“œ
        async function loadAttendees() {
            try {
                if (!window.firebaseManager) {
                    console.log('Firebase Manager ì´ˆê¸°í™” ì¤‘...');
                    return;
                }

                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                firebaseUnsubscribe = window.firebaseManager.listenToAttendees((data) => {
                    attendees = data;
                    updateUI();
                });

                console.log('Firebase ì—°ê²° ì„±ê³µ');
            } catch (error) {
                console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì—”í„°í‚¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const phoneInput = document.getElementById('newPhone');
                    if (phoneInput.value.trim()) {
                        addAttendee();
                    } else {
                        phoneInput.focus();
                    }
                }
            });

            document.getElementById('newPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addAttendee();
                }
            });
        });

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshAllData() {
            try {
                console.log('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
                
                if (window.firebaseManager) {
                    // Firebaseì—ì„œ ì§ì ‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const freshData = await window.firebaseManager.getAttendees();
                    attendees = freshData.map(a => ({
                        id: a.id,
                        name: a.name || '',
                        phone: a.phone || '',
                        checkedIn: a.checkedIn || false,
                        checkedInAt: a.checkedInAt || '',
                        timestamp: a.timestamp
                    }));
                    
                    updateUI();
                    
                    // ì„±ê³µ ì•Œë¦¼
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = `âœ… ${attendees.length}ëª…ì˜ ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                } else {
                    alert('âŒ Firebase ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                alert('âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¹ ë¥¸ í†µê³„ ë³´ê¸°
        function showQuickStats() {
            if (attendees.length === 0) {
                alert('í†µê³„ë¥¼ ë³´ì—¬ì¤„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const checkedInAttendees = attendees.filter(a => a.checkedIn);
            const waitingAttendees = attendees.filter(a => !a.checkedIn);
            
            // ì‹œê°„ëŒ€ë³„ ì²´í¬ì¸ ë¶„ì„ (ì²´í¬ì¸ëœ ì‚¬ëŒë“¤ë§Œ)
            const checkinTimes = checkedInAttendees
                .filter(a => a.checkedInAt)
                .map(a => new Date(a.checkedInAt).getHours())
                .sort((a, b) => a - b);
            
            let timeAnalysis = '';
            if (checkinTimes.length > 0) {
                const earliest = Math.min(...checkinTimes);
                const latest = Math.max(...checkinTimes);
                timeAnalysis = `
â° ì²´í¬ì¸ ì‹œê°„ëŒ€:
â€¢ ê°€ì¥ ë¹ ë¥¸ ì²´í¬ì¸: ${earliest}ì‹œ
â€¢ ê°€ì¥ ëŠ¦ì€ ì²´í¬ì¸: ${latest}ì‹œ`;
            }

            const statsMessage = `ğŸ“Š ë¹ ë¥¸ í†µê³„

ğŸ‘¥ ì „ì²´ ì°¸ì„ì: ${attendees.length}ëª…
âœ… ì²´í¬ì¸ ì™„ë£Œ: ${checkedInAttendees.length}ëª…
â³ ëŒ€ê¸° ì¤‘: ${waitingAttendees.length}ëª…

ğŸ“Š ì²´í¬ì¸ë¥ : ${attendees.length > 0 ? Math.round((checkedInAttendees.length / attendees.length) * 100) : 0}%${timeAnalysis}`;
            
            alert(statsMessage);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            loadAttendees();
        });
    </script>
</body>
</html>